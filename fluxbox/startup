#!/bin/bash
#
# fluxbox startup-script
#
# Lines starting with a '#' are ignored.

# 设置中文
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
export LANGUAGE=zh_CN

# 启动独立的 D-Bus 会话
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    eval $(dbus-launch --sh-syntax --exit-with-session)
    export DBUS_SESSION_BUS_ADDRESS
fi
# echo $DBUS_SESSION_BUS_ADDRESS
# dbus-launch nautilus

# XDG
# export XDG_CURRENT_DESKTOP=Fluxbox
# export XDG_SESSION_DESKTOP=fluxbox

# 设置壁纸（带 1 秒延迟，防止 X 服务器未完全启动）
(sleep 1 && /usr/bin/fbsetbg -a ~/.fluxbox/backgrounds/music-white-black-hd-wallpaper.jpg) &
# (sleep 1 && /usr/bin/fbsetbg -a ~/.fluxbox/backgrounds/bingimg_20230129_UHD.jpg) &
# (sleep 1 && /usr/bin/fbsetbg -a ~/.fluxbox/backgrounds/bingimg_20240410_UHD.jpg) &
# 或者sudo apt install nitrogen
# nitrogen --restore &
# (sleep 1 && /usr/bin/fbsetbg -a ~/.fluxbox/backgrounds/zetong-li-TbHYpbi_Gbc-unsplash.jpg) &

# 启动 fcitx5（避免重复运行）
pgrep -x fcitx5 > /dev/null || fcitx5 &
# 启动 fcitx4（避免重复运行）
# pgrep -x fcitx > /dev/null || fcitx &

# 启动网络管理器托盘（避免重复运行）
pgrep -x nm-tray > /dev/null || nm-tray &
# pgrep -x nm-applet > /dev/null || nm-applet &
# nm-applet &
# nm-tray&

# 启动蓝牙管理器（避免重复运行）
# pgrep -x blueman-applet > /dev/null || blueman-applet &

# 音量控制
# 启动 pasystray pulse
# pasystray &
# 启动 volumeicon alsa
# volumeicon &


# 启动conky
# conky&

# 设置普通美式键盘布局
setxkbmap us &
# 设置默认支持英文和中文
# setxkbmap -layout cn,us &
# 设置带有国际字符支持的美国英语键盘布局
# setxkbmap us -variant intl & # 在 us 键盘中添加特殊字符支持 (类似 éóíáú) 

# 启动gvfs
#/usr/libexec/gvfsd &
#/usr/libexec/gvfs-udisks2-volume-monitor &

# 认证
# sudo apt install lxpolkit
lxpolkit &
# 或者GNOME的 sudo usermod -aG plugdev $USER
# /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 &


# 启动 PolicyKit 认证代理（根据你的发行版选择）
#if command -v /usr/libexec/polkit-gnome-authentication-agent-1 >/dev/null 2>&1; then
#    /usr/libexec/polkit-gnome-authentication-agent-1 &
#elif command -v /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 >/dev/null 2>&1; then
#    /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 &
#elif command -v lxpolkit >/dev/null 2>&1; then
#    lxpolkit &
#fi


# 启动剪贴板管理器（可选）
# if command -v parcellite >/dev/null 2>&1; then
#     parcellite &
# elif command -v clipit >/dev/null 2>&1; then
#     clipit &
# fi

# 启动文件管理器的自动挂载支持（可选）
# if command -v thunar >/dev/null 2>&1; then
#     thunar --daemon &
# elif command -v pcmanfm >/dev/null 2>&1; then
#     pcmanfm -d &
# fi

# 自动解锁密钥环
if [ -z "$GNOME_KEYRING_PID" ]; then
    eval $(gnome-keyring-daemon --start --components=pkcs11,secrets,ssh,gpg)
    export SSH_AUTH_SOCK
fi

# 如果你用 lightdm，可以让它在登录时自动解锁密钥环
# sudo apt install libpam-gnome-keyring
# sudo nano /etc/pam.d/lightdm
# 找到@include common-auth
# 下面添加
# auth optional pam_gnome_keyring.so
# session optional pam_gnome_keyring.so auto_start


# 使用 numlockx 工具来控制小键盘状态。
# sudo apt install numlockx  # Debian/Ubuntu
numlockx on & # 启用小键盘（默认开启）
# numlockx off &

# 加载 Xmodmap（如果文件存在）
[ -f ~/.Xmodmap ] && xmodmap ~/.Xmodmap

# 你希望在 Fluxbox 启动时运行的应用程序  
# 确保 **需要常驻运行的程序** 末尾加上 '&'，否则会阻塞 Fluxbox 启动  
# unclutter -idle 2 &  # 鼠标静止 2 秒后自动隐藏指针  
# wmnd &  # 运行网络监视工具  
# wmsmixer -w &  # 运行音量控制器  
# idesk &  # 在桌面显示图标  

# Debian 相关改动：  
# - `fbautostart` 被加入，并通过简单的检测方法检查其是否存在。  
# - 如果 `fbautostart` 存在，我们会默认启动它。  
# 自动启动其他应用（如果 fbautostart 存在）
# fbautostart 是 Debian 里的一个工具，它的作用是自动运行 ~/.config/autostart/ 目录下的程序，或者其他 XDG 相关的自启动项
command -v fbautostart >/dev/null && fbautostart &
# 最后，我们启动 Fluxbox。因为它是最后运行的应用程序，你必须在它前面加上 exec。
# exec fluxbox
# 如果你想要保存日志:
exec fluxbox -log "/home/jessie/.fluxbox/log"
